<html>
<head>
<script type="text/javascript" src="prefs.js"></script>
<script>
var REQUEST_TIMEOUT_MS_ = 5 * 1000;
var FEED_URL = "/sr/jira.issueviews:searchrequest-xml/temp/SearchRequest.xml?field=key&field=summary&field=description&field=link&field=type&field=priority&jqlQuery=";
var RESULTS_PER_PAGE = 10;


var requestTimeout;
var loadingAnimation = new LoadingAnimation();
var issueCount;

var processor = new XSLTProcessor();
var serializer = new XMLSerializer();

function LoadingAnimation() {
	this.timerId_ = 0;
	this.maxCount_ = 8;  // Total number of states in animation
	this.current_ = 0;  // Current state
	this.maxDot_ = 4;  // Max number of dots in animation
}

LoadingAnimation.prototype.paintFrame = function() {
	var text = "";
	for (var i = 0; i < this.maxDot_; i++) {
		text += (i == this.current_) ? "." : " ";
	}
	if (this.current_ >= this.maxDot_)
		text += "";

	chrome.browserAction.setBadgeText({text:text});
	this.current_++;
	if (this.current_ == this.maxCount_)
		this.current_ = 0;
}

LoadingAnimation.prototype.start = function() {
	if (this.timerId_)
		return;

	var self = this;
	this.timerId_ = window.setInterval(function() {
		self.paintFrame();
	}, 100);
}

LoadingAnimation.prototype.stop = function() {
	if (!this.timerId_)
		return;

	window.clearInterval(this.timerId_);
	this.timerId_ = 0;
}

function init() {
	chrome.browserAction.setBadgeBackgroundColor({color:[208, 0, 24, 255]});
	chrome.browserAction.setIcon({path: "icon-signed-in.png"});
	loadingAnimation.start();
	issueCount = -1;

	var xsltFile = chrome.extension.getURL('jira.xsl');
	var xhr = new XMLHttpRequest();
	xhr.open("GET", xsltFile, false);
	xhr.send(null);
	var xsl = xhr.responseXML;
	processor.importStylesheet(xsl);
	processor.setParameter(null, "perPage", RESULTS_PER_PAGE);

	startRequest();
}

function scheduleRequest() {
	if (requestTimeout) {
		window.clearInterval(requestTimeout);
	}
	var interval = getRefreshInterval();
	requestTimeout = window.setTimeout(startRequest, interval);  
}

function startRequest() {
	getIssueCount(
		function(count) {
			loadingAnimation.stop();
			updateIssueCount(count);
			scheduleRequest();
		},
		function() {
			loadingAnimation.stop();
			showLoggedOut();
			scheduleRequest();
		}
	);
}

function showLoggedOut() {
	chrome.browserAction.setIcon({path:"icon-signed-out.png"});
	chrome.browserAction.setBadgeBackgroundColor({color:[190, 190, 190, 230]});
	chrome.browserAction.setBadgeText({text:"?"});
}

function updateIssueCount(count) {
	if (issueCount != count) {
		issueCount = count;
		chrome.browserAction.setIcon({path:"icon-signed-in.png"});
		if (issueCount > 0) {
			chrome.browserAction.setBadgeText({text: issueCount + ""});
			chrome.browserAction.setBadgeBackgroundColor({color:[208, 0, 24, 255]});
		} else {
			chrome.browserAction.setBadgeText({text: '' });
			chrome.browserAction.setBadgeBackgroundColor({color:[0,0,0,0]});
		}
	}
}

function getIssueCount(onSuccess, onError) {
	var xhr = new XMLHttpRequest();
	var abortTimerId = window.setTimeout(function() {
		xhr.abort();  // synchronously calls onreadystatechange
	}, REQUEST_TIMEOUT_MS_);
	
	function handleSuccess(count) {
		window.clearTimeout(abortTimerId);
		if (onSuccess)
			onSuccess(count);
	}

	function handleError() {
		window.clearTimeout(abortTimerId);
		if (onError)
			onError();
	}

	try {
		xhr.onreadystatechange = function(){
			if (xhr.readyState != 4)
				return;

			if (xhr.responseXML) {
				var xmlDoc = xhr.responseXML;
				var fullCountSet = xmlDoc.evaluate("/rss/channel/issue/@total",
					xmlDoc, null, XPathResult.ANY_TYPE, null);
				var fullCountNode = fullCountSet.iterateNext();
				if (fullCountNode) {
					handleSuccess(fullCountNode.textContent);
					return;
				}
			}

			handleError();
		}

		xhr.onerror = function(error) {
			handleError();
		}

		xhr.open("GET", getFeedUrl(0), true);
		xhr.send(null);
	} catch(e) {
		handleError();
	}
}

function getTable(start, onSuccess, onError) {
	var xhr = new XMLHttpRequest();
	var abortTimerId = window.setTimeout(function() {
		xhr.abort();  // synchronously calls onreadystatechange
	}, REQUEST_TIMEOUT_MS_);
	
	function handleSuccess(table) {
		window.clearTimeout(abortTimerId);
		if (onSuccess)
			onSuccess(table);
	}

	function handleError() {
		window.clearTimeout(abortTimerId);
		if (onError)
			onError();
	}

	try {
		xhr.onreadystatechange = function(){
			if (xhr.readyState != 4)
				return;

			if (xhr.responseXML) {
				var xmlDoc = xhr.responseXML;
				var doc = processor.transformToDocument(xmlDoc);
				var table = serializer.serializeToString(doc.documentElement);
				if (table) {
					handleSuccess(table);
					return;
				}
			}

			handleError();
		}

		xhr.onerror = function(error) {
			handleError();
		}

		xhr.open("GET", getFeedUrl(RESULTS_PER_PAGE) + "&pager/start=" + start, true);
		xhr.send(null);
	} catch(e) {
		handleError();
	}
}

function getFeedUrl(count) {
	var url = getJiraUrl();
	url += FEED_URL + encodeURI(getQuery());
	url += "&tempMax=" + count;
	return url;
}

function isJiraUrl(jiraUrl, onSuccess, onError) {
	var url = jiraUrl + FEED_URL + encodeURI(getQuery()) + "&tempMax=0";
	var xhr = new XMLHttpRequest();
	var abortTimerId = window.setTimeout(function() {
		xhr.abort();  // synchronously calls onreadystatechange
	}, REQUEST_TIMEOUT_MS_);
	
	function handleSuccess() {
		window.clearTimeout(abortTimerId);
		if (onSuccess)
			onSuccess();
	}

	function handleError() {
		window.clearTimeout(abortTimerId);
		if (onError)
			onError();
	}

	try {
		xhr.onreadystatechange = function(){
			if (xhr.readyState != 4)
				return;

			if (xhr.responseXML) {
				var xmlDoc = xhr.responseXML;
				var versionNode = xmlDoc.evaluate("/rss/channel/build-info/version",
					xmlDoc, null, XPathResult.STRING_TYPE, null);
				if (versionNode.stringValue.indexOf("4.") === 0) {
					handleSuccess();
					return;
				}
			}

			handleError();
		}

		xhr.onerror = function(error) {
			handleError();
		}

		xhr.open("GET", url, true);
		xhr.send(null);
	} catch(e) {
		handleError();
	}
}

</script>
</head>
<body onload="init()">

</body>
</html>